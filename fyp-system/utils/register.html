<?php
require_once $_SERVER['DOCUMENT_ROOT'] . '/FYP-System/php/database.php';
require_once $_SERVER['DOCUMENT_ROOT'] .'/FYP-System/php/logger.php';

// Get the database connection instance
$db = Database::getInstance();
$conn = $db->getConnection();

$logger = new Logger("logs/app.log");

// Collect form data
$name = $_POST['name'] ?? ''; 
$email = $_POST['email'] ?? '';
$student_id = $_POST['student_id'] ?? '';
$password = $_POST['password'] ?? ''; 
$confirm_password = $_POST['confirm_password'] ?? '';
$phone_number = $_POST['phone_number'] ?? '';

// Log form data
$logger->info("Received data: $name, $email, $student_id, $password, $confirm_password, $phone_number<br>");

// Validate passwords
if ($password !== $confirm_password) {
    $logger->info("Passwords do not match.");
}

// Hash the password
$hashed_password = password_hash($password, PASSWORD_BCRYPT);

// Prepare and bind SQL statement
$sql = "INSERT INTO USERS (id, name, email, password, phone_number, role) VALUES (?, ?, ?, ?, ?, ?)";
$stmt = $conn->prepare($sql);

// Check if preparation was successful
if (!$stmt) {
    die("Error preparing SQL statement: " . $conn->error);
}

// Set role to "student"
$role = "student";

// Bind parameters to the SQL query
$stmt->bind_param("ssssss", $student_id, $name, $email, $hashed_password, $phone_number, $role);

// Execute the query
if ($stmt->execute()) {
    $logger->info("Registration successful!");
} else {
    $logger->error("Error: " . $stmt->error);
}

// Close the connection
$stmt->close();
$conn->close();
?>
